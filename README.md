# Чтение защищённой прошивки STM32F0x с помощью Pi Pico

Небольшой PoC, который извлекает 32‑битные слова из защищённой флеш STM32F0x через гонку на шине SWD. Суть: не «болтать» с МК, а сразу после сброса выполнить минимальный набор команд SWD — успевает прочитаться одно слово до срабатывания защиты. Для атаки надо уметь управлять и питанием, и линией reset цели, потому что сброс защиты чтения SWD происходит только после полного обесточивания.

В сети есть другие PoC этого эксплойта debug‑режима, но чаще они завязаны на STM32 с MBED SDK и большим стеком зависимостей. Здесь всё сделано на PlatformIO и портировано на Raspberry Pi Pico (RP2040), чтобы собрать «из коробки».

Работает **только** при защите чтения уровня 1 (RDP Level 1): SWD активен, но после первого обращения защита срабатывает. Уровень 2 полностью блокирует SWD, поэтому этот метод не подходит. С другими линейками STM32 может заработать, но не проверялось (буду рад отчётам).

# Сборка

Установите PlatformIO:

```bash
pip install platformio
```

Или смотрите инструкции под вашу платформу на https://platformio.org/

Собрать прошивку:

```bash
pio run
```

Готовый UF2 будет в `.pio/pico/firmware.uf2`.

Можно пользоваться и плагином PlatformIO для VS Code.

# Использование

Назначение пинов в [include/main.h](include/main.h):

```c
#define TARGET_RESET_Pin 27
#define TARGET_PWR_Pin 26
#define SWDIO_Pin 14
#define SWCLK_Pin 15
```

Pico должно полностью отключать питание цели по `TARGET_PWR_Pin`. Если плата — голый STM32 или с минимальной обвязкой, можно подавать 3.3 В прямо с Pico (учтите небольшой допустимый ток). Если сомневаетесь — ставьте реле/мосфет на питание цели.

Если объём флеш памяти STM32 отличается от 32 КБ, поправьте параметр `size` в [main.cpp](src/main.cpp). При другой стартовой адресации измените `flashAddress`.

После подачи питания Pico будет слать по UART строку `Send anything to start...` — значит, готово. Отправьте любой байт и увидите дамп:

```
Send anything to start...
Starting
0x08000000: deadbeef
0x08000004: deadbeef
0x08000008: deadbeef
0x0800000C: deadbeef
0x08000010: deadbeef
0x08000014: deadbeef
0x08000018: deadbeef
```

Чтобы сохранить в файл, используйте скрипт `dump.py`.

# Отказ от ответственности

Код основан на статье Йоханнеса Обермайера [Shedding too much Light on a Microcontroller's Firmware Protection](https://www.aisec.fraunhofer.de/en/FirmwareProtection.html). Часть его PoC перенесена на Raspberry Pi Pico и PlatformIO, поэтому распространяется под той же лицензией MIT.
